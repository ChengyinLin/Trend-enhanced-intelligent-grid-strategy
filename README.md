# 趋势增强型智能网格策略 v5.1

基于v5.0跑出收益不乐观，进行常见负收益原因诊断！
根据量化交易研究[Quantitative Trading_ How to Build Your Own Algorithmic Trading Business.pdf](https://github.com/user-attachments/files/25523527/Quantitative.Trading_.How.to.Build.Your.Own.Algorithmic.Trading.Business.pdf)，网格
策略亏损的主要原因包括：

Kelly仓位计算错误 - 初始Kelly为0导致无法建仓

网格间距过大 - 价格长期不触及网格导致空仓

止损过于敏感 - 频繁止损割肉

趋势判断错误 - 在下跌趋势中持续加仓

交易成本忽略 - 未考虑手续费和滑点

## 关键修复点
| 问题            | 原因                              | 修复方案                                  |
| ------------- | ------------------------------- | ------------------------------------- |
| **Kelly初始为0** | `current_kelly`初始化为0，导致前N笔无法建仓  | 添加`kelly_initial=0.15`参数，确保初始有仓位      |
| **网格间距过大**    | `base_grid_pct=0.035`导致价格难以触及   | 降低到`0.025`，增加`grid_levels`到10层        |
| **止损过于敏感**    | `stop_loss=0.12`在震荡市容易被触发       | 放宽到`0.20`，`atr_stop_multiplier`提高到3.0 |
| **现金储备过高**    | `min_cash_reserve=0.10`导致资金利用率低 | 降低到`0.02`                             |
| **忽略交易成本**    | 未考虑手续费和滑点                       | 添加`commission_rate`和`slippage`        |
| **趋势过滤过严**    | `should_trade`要求alignment>0.5   | 放宽到>-0.2，允许弱趋势交易                      |


----------------------------------------------------------------------

# 趋势增强型智能网格策略 v5.0 (Kelly优化版)
重点引入Kelly准则动态仓位管理、波动率聚类优化和多时间框架协同，这些技术能显著提升收益风险比。

此策略更换标的为：
[300568历史数据.csv](https://github.com/user-attachments/files/25523126/300568.csv)
更换原因：603993后期多为单向上升趋势

## 核心优化策略
1.Kelly准则自适应仓位管理（最大改进点）
将固定仓位改为基于历史表现的Kelly最优仓位

2.波动率聚类感知网格（提升20-30%收益）
根据波动率聚类特性动态调整网格密度

3.多时间框架动量共振（过滤假信号）

4.智能再平衡触发器（替代固定间隔）

5.整合到主策略的修改

## 预期改进效果
根据研究 https://arxiv.org/html/2508.16598v1 ，这些优化预计带来：

Kelly仓位管理：提升年化收益 15-25%，同时降低最大回撤 30-40%

波动率聚类适应：在震荡市中减少无效交易 20-30%，提升夏普比率

多时间框架过滤：减少假突破损失约 15-20%

智能再平衡：降低交易成本 10-15%

## 关键改进总结
| 模块        | v4.0  | v5.0 (Kelly优化版)      | 预期提升      |
| --------- | ----- | -------------------- | --------- |
| **仓位管理**  | 固定比例  | Kelly准则 + 贝叶斯更新      | +15-25%收益 |
| **波动率适应** | 简单ATR | 波动率聚类检测 (GARCH-like) | -20%无效交易  |
| **信号过滤**  | 单时间框架 | 多时间框架共振 (5/20/60日)   | +15%胜率    |
| **再平衡**   | 固定间隔  | 信息熵驱动的智能触发           | -15%交易成本  |
| **风险控制**  | 固定止损  | ATR止损 + Kelly动态调整    | -30%回撤    |

<img width="3676" height="5140" alt="comprehensive_analysis_v5_kelly" src="https://github.com/user-attachments/assets/58959f4e-98a5-4b2c-a7ec-e17a4f6fcb58" />



----------------------------------------------------------------------

# 趋势增强型智能网格策略 v4.0 (全面修复优化版)
由于V3.1版本当前参数可能过于激进

| 参数                          | 当前值  | 建议调整            | 理由            |
| --------------------------- | ---- | --------------- | ------------- |
| `base_grid_pct`             | 2.5% | 3.5-4%          | 避免震荡市频繁交易     |
| `grid_levels`               | 7    | 5               | 减少深度套牢风险      |
| `stop_loss`                 | 15%  | 12% 或 ATR-based | 15%在A股波动中可能过大 |
| `cooldown_days`             | 20   | 10-15           | 20天可能错过反弹     |
| `position_update_threshold` | 5%   | 8%              | 减少不必要的网格重建    |


### 修复内容：
1. 网格中心更新逻辑缺陷 - 价格对齐与盈利安全检查
2. 趋势加仓逻辑 - 多因子确认机制
3. 仓位动态平衡 - 金字塔式网格仓位管理
4. 止损后渐进式重启 - 分批建仓机制
5. 可视化索引对齐 - 基于merge_asof的时间对齐
6. 风险管理 - 流动性储备与跨时间框架验证
7. 绩效指标 - Sortino Ratio、盈亏比等高级指标
8. 波动率自适应网格 - 动态间距调整
9. 跨时间框架验证 - 周线趋势过滤
10. 动态止损 - ATR-based Chandelier Exit

### 主要修复与优化总结：

1.核心修复

网格中心更新：增加价格比例调整与盈利安全检查，避免转移后无法盈利

时间对齐：使用 pd.merge_asof 替代索引对齐，确保时间序列安全匹配

卖出逻辑：保持先保存数据再清零的修复

2.关键增强

金字塔仓位：层级越高（价格越低）仓位越大，但用平方根控制增速

多因子加仓：增加周线趋势、成交量、RSI、波动率四重过滤

渐进式重启：止损后分3批建仓，每批间隔5天，降低一次性重仓风险

双止损机制：固定比例止损 + ATR-based Chandelier Exit

自适应网格：每20天检查波动率变化，动态调整间距

流动性管理：强制保留10%现金储备，防止满仓套牢

3.新增指标

Sortino Ratio：只惩罚下行波动

Profit Factor：总盈利/总亏损

Win/Loss Ratio：平均盈利/平均亏损

连续盈亏统计：最大连续盈利/亏损次数

平均持仓天数

4.参数调整建议

网格层数：7→5（降低深度套牢风险）

基础间距：2.5%→3.5%（减少震荡市交易频率）

止损线：15%→12%（更严格风控）

冷却期：20→12天（更快恢复交易）

### 🚀 性能优化
使用 Numba/JIT 加速循环部分

<img width="3366" height="4524" alt="comprehensive_analysis_v4" src="https://github.com/user-attachments/assets/ccd53c00-56e7-45fd-addb-dedcb5021167" />

### 回测结果
初始资金:                             100,000 CNY
最终价值:                             128,928 CNY
总收益率:                               28.93 %
年化收益:                                4.41 %
最大回撤:                               38.16 %

夏普比率:                                0.24
索提诺比率:                               0.26
卡玛比率:                                0.12
盈亏比:                                 1.80
盈利因子:                                5.40

总交易次数:                                296
买入次数:                                   6
卖出次数:                                   4
止损次数 (固定):                             96
ATR止损次数:                                0
网格强制平仓:                                 0
趋势加仓:                                   0
趋势减仓:                                   0
重启建仓:                                 190

胜率:                                  75.0 %
平均盈亏:                               1,345 CNY
平均盈利:                               2,201 CNY
平均亏损:                              -1,222 CNY
总盈亏:                                5,380 CNY
最大连续盈利:                                 3
最大连续亏损:                                 1
平均持仓天数:                              36.8




----------------------------------------------------------------------

# Trend-enhanced-intelligent-grid-strategy--V3.1
趋势增强型智能网格策略 v3.1 (Bug修复版)

修复了可视化中的索引对齐问题

修复内容
主要修复了 create_comprehensive_report 方法中的索引对齐问题

## 其他改进：
修复了 StrategyVisualizer 的初始化：现在正确传递 config 参数

改进了买入持有基准的查找逻辑：使用 idxmax() 找到第一个满足条件的索引

添加了收益对比标注：在图表上显示策略和买入持有的具体收益率

修复了成交量颜色计算：使用 diff() 计算涨跌，避免字符串列的问题

<img width="3280" height="3945" alt="comprehensive_analysis" src="https://github.com/user-attachments/assets/66bc9080-20f8-4189-ae2a-7ba8f952c5de" />



----------------------------------------------------------------------
# Trend-enhanced-intelligent-grid-strategy--V3.0
趋势增强型智能网格策略 v3.0 - 优化版

修复了原版的bug，提升了性能，优化了代码结构

主要优化：
1. 预计算所有技术指标，避免循环中重复计算
2. 修复execute_sell的bug
3. 分离网格管理逻辑
4. 添加更完善的风险管理
5. 优化内存使用和运行速度

主要优化点总结
1. Bug修复

✅ 修复了 execute_sell 中先清零 grid['shares'] 再记录交易的问题
✅ 添加了浮点数比较容差（<= 1e-10）
✅ 完善了边界条件检查

2. 性能优化

✅ 预计算所有指标：使用向量化计算，避免循环中重复切片DataFrame
✅ 使用 @dataclass(slots=True)：减少Trade对象的内存占用
✅ 分离GridManager：网格逻辑独立管理，更清晰高效

3. 代码结构优化

✅ 配置对象化：使用 StrategyConfig 管理参数
✅ 模块化设计：GridManager独立管理网格
✅ 类型注解完善：提高代码可读性和IDE支持

4. 功能增强

✅ 更智能的网格更新：添加 position_update_threshold 避免过于频繁调整
✅ 完善的风险管理：支持多种止损类型
✅ 更详细的交易记录：记录网格层级信息

5. 可视化优化

✅ 修复买入持有基准计算：正确对齐日期
✅ 更美观的图表：优化颜色、标签、注释
✅ 新增卡玛比率：收益/回撤比
运行这个版本应该会比原版快 3-5倍（主要得益于预计算指标），并且更加稳定健壮。

<img width="1621" height="371" alt="image" src="https://github.com/user-attachments/assets/9d097f48-ef5d-423f-a3c9-540143e4a3cb" />

### 回测结果

初始资金:                        100,000 CNY

最终价值:                        152,863 CNY

总收益率:                          52.86 %

年化收益:                           7.37 %

最大回撤:                          13.25 %

夏普比率:                           0.59

卡玛比率:                           0.56


总交易次数:                            69
买入次数:                             34
卖出次数:                             33
止损次数:                              0
趋势加仓:                              0
趋势减仓:                              2

胜率:                             60.6 %
平均盈亏:                          1,005 CNY
总盈亏:                          33,161 CNY



----------------------------------------------------------------------
# Trend-enhanced-intelligent-grid-strategy--V2.0
趋势增强型智能网格策略 v2.0 - 优化版
基于股票历史数据回测优化

优化要点：
1. 动态网格间距：基于ATR波动率自适应调整
2. 趋势评分系统：多时间框架均线排列+动量
3. 智能仓位管理：趋势增强+波动率调整
4. 止损冷却机制：止损后20日冷却+自动重启
5. 趋势跟踪加仓：强趋势突破时追加仓位
6. 成交量过滤：低于均量60%不买入

【原始策略问题诊断】
--------------------------------------------------------------------------------
   基于603993(2020-2025)数据回测发现：
1. 单边上涨行情(2020-2021)：网格策略过早卖出，错失主升浪
2. 震荡行情(2022-2023)：网格交易频繁，但收益有限
3. 快速下跌时：止损机制不完善，回撤较大
4. 固定网格间距：无法适应不同波动率环境

【核心优化措施】
--------------------------------------------------------------------------------

1. 动态网格间距
   方法: 基于ATR波动率自适应调整
   效果: 高波动时扩大网格(避免频繁交易)，低波动时缩小网格(提高成交效率)

2. 趋势评分系统
   方法: 多时间框架均线排列+动量+RSI
   效果: 识别单边趋势，在强上涨趋势中减少卖出，在下跌趋势中减少买入

3. 智能仓位管理
   方法: 基础仓位×趋势因子×波动率调整
   效果: 强趋势时增加仓位，高波动时降低仓位，控制单次风险暴露

4. 止损冷却机制
   方法: 15%最大回撤止损+20日冷却期
   效果: 防止连续止损，冷却期后自动重新初始化网格

5. 趋势跟踪加仓
   方法: 趋势强度>0.7且突破20日高点时加仓
   效果: 在确认上涨趋势后追加仓位，分享趋势收益

6. 成交量过滤
   方法: 低于20日均量60%时不买入
   效果: 避免流动性不足时的无效交易，提高成交质量

| 优化点      | 原始策略 | 优化后策略            |
| -------- | ---- | ---------------- |
| **网格间距** | 固定2% | ATR动态调整(1.5%-6%) |
| **趋势判断** | 无    | 多时间框架均线+RSI评分    |
| **仓位管理** | 固定比例 | 趋势增强×波动率调整       |
| **止损机制** | 简单止损 | 15%回撤+20日冷却+自动重启 |
| **加仓逻辑** | 无    | 趋势突破加仓           |
| **成交过滤** | 无    | 成交量<60%均量不买入     |


📊 生成的可视化图表
1. comprehensive_strategy_analysis.png - 综合策略分析（大图）
包含10个子图：

主图：策略净值 vs 买入持有对比

交易信号：股票价格与买卖点标记（买入△/卖出▽/止损×/加仓★/减仓◇）

持仓比例：仓位分配随时间变化

现金储备：现金余额变化

趋势指标：-1到1的趋势强度评分

RSI指标：14日相对强弱指数

回撤分析：最大回撤24.51%标记

成交量：交易量分布

盈亏分布：每笔交易盈亏（胜率100%）

交易统计：买卖/止损/加仓/减仓次数

<img width="3280" height="3954" alt="comprehensive_strategy_analysis" src="https://github.com/user-attachments/assets/ce9355b8-6a36-447a-b238-cc11fbc6c0e5" />

2. supplementary_analysis.png - 补充分析
包含4个子图：

月度收益热力图：2020-2026年各月收益率分布

滚动收益波动率：60日滚动年化收益与波动率

交易效率：持仓时间与收益率关系

相关性分析：策略与买入持有的滚动相关性

<img width="3175" height="2376" alt="supplementary_analysis" src="https://github.com/user-attachments/assets/c1e873d2-d1f2-4dc7-995f-613900da9e18" />

3. strategy_mechanism.png - 策略原理演示
包含4个子图：

网格机制：典型网格交易买卖示意图

动态间距：静态网格 vs ATR动态网格对比

趋势评分：多因子趋势计算逻辑

优化对比：原始策略与优化策略的5项指标对比

<img width="3177" height="2379" alt="strategy_mechanism" src="https://github.com/user-attachments/assets/884e3a85-a998-47ec-8e8c-9cae54e9d4cc" />

📈 关键发现
| 指标       | 优化策略    | 买入持有    |
| -------- | ------- | ------- |
| **总收益率** | 40.72%  | 377.83% |
| **最大回撤** | 24.51%  | ~50%    |
| **夏普比率** | 0.35    | ~0.8    |
| **胜率**   | 100%    | -       |
| **交易频率** | 14.9次/年 | -       |

结论：优化后的网格策略在单边上涨行情中大幅跑输买入持有，但在风险控制（回撤24.51% vs 50%）和交易胜率（100%）方面表现优异，更适合震荡市或作为风险对冲工具使用。

### 回测结果
总收益率:         40.72%
年化收益:          5.89%
最大回撤:         24.51%
夏普比率:           0.35
交易次数:             89


【策略适用性分析】
--------------------------------------------------------------------------------
✅ 适用场景：
   - 震荡行情（网格交易优势）
   - 波动率较高的市场（动态网格有效）
   - 无法判断方向的结构性行情（趋势过滤）
   - 风险厌恶型投资者（回撤控制）

❌ 不适用场景：
   - 强单边上涨行情（如2020-2021年的603993）
   - 流动性极差的市场（成交量过滤会阻止交易）
   - 极速下跌行情（15%止损可能来不及）
   - 追求高收益的投资者（收益上限受限）


如何获取股票的CSV数据：（可参照我的飞书云文档链接）！！
https://my.feishu.cn/wiki/WJ3UwK6HNiymaSk7DgVcI02lnog?from=from_copylink

下载Anaconda链接：https://www.anaconda.com/download

下载VScode链接：https://code.visualstudio.com/
